<html>
  <head>
    <title>Captcah Label Tool</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.rawgit.com/needim/noty/77268c46/lib/noty.css">
  </head>
  <body>

    <div class="container">
      <h2>標註你的驗證碼 labeling the captcha</h2>
      <p>驗證碼可放置於 captcha 目錄，由 1.jpg, 2.jpg, 依此類推。</p>
      <p>Please locate captcha in <strong>captcha</strong> folder, 1.jpg, 2.jpg and etc.</p>

      <div class="row mb-5">
        <div class="col-8">
          <label for="autoTab">自動跳下一組 (Jump next captcha automatically):</label>
          <select id="autoTab" name="autoTab" class="form-control">
              <option value="0">Disable</option>
              <option value="4" selected>4 char</option>
              <option value="5">5 char</option>
              <option value="6">6 char</option>
          </select>
        </div>
        <div class="col-4">
          <nav>
            <ul id="pagination1" class="pagination pagination-md justify-content-center">
              <li class="page-item"><a class="page-link" href="#">Previous</a></li>
              <li class="page-item active"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">Next</a></li>
            </ul>
          </nav>
        </div>
      </div>

      <div class="row">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Image</th>
              <th>Label</th>
            </tr>
          </thead>
          <tbody>
            <tr class="rowLabel">
              <td></td>
              <td><img src=""></td>
              <td><input type="text" class="form-control"></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="row">
        <button id="loadCache" type="button" class="btn btn-lg btn-info mr-3">Load Cache</button>
        <button id="saveCache" type="button" class="btn btn-lg btn-info mr-3">Save Cache</button>
        <button id="export" type="button" class="btn btn-lg btn-primary">Export as CSV</button>
      </div>

      <nav>
        <ul id="pagination2" class="pagination pagination-lg justify-content-center">
          <li class="page-item"><a class="page-link" href="#">Previous</a></li>
          <li class="page-item active"><a class="page-link" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">Next</a></li>
        </ul>
      </nav>

    </div>
  </body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.rawgit.com/needim/noty/77268c46/lib/noty.min.js"></script>
  <script type="text/javascript">

      function generateTable(size) {
        for (i = 1; i < size; i++) {
          $("tbody").append("<tr>" + $(".rowLabel").html() + "</tr>");
        }
      }

      function assignImage(page, size) {
        for (i = 1; i <= $("tbody tr").length; i++) {
          let no = (page - 1) * size + i;
          $("tbody tr").eq(i - 1).find("td").eq(0).text(no);
          $("tbody tr").eq(i - 1).find("img").attr("src", "captcha/" + no + ".jpg");
        }
      }

      function assignPagination(page, size, autoTab) {
        let p = parseInt(page) - 1;
        for (i = 1; i <= 3; i++) {
          if (p <= 0) {
            $("#pagination1 a").eq(i - 1).hide();
            $("#pagination2 a").eq(i - 1).hide();
          } else {
            $("#pagination1 a").eq(i - 1).show();
            $("#pagination1 a").eq(i - 1).text(p);
            $("#pagination1 a").eq(i - 1).attr("href", "?page=" + p + "&size=" + size + "&autoTab=" + autoTab);
            $("#pagination2 a").eq(i - 1).show();
            $("#pagination2 a").eq(i - 1).text(p);
            $("#pagination2 a").eq(i - 1).attr("href", "?page=" + p + "&size=" + size + "&autoTab=" + autoTab);
          }
          p++;
        }
      }

      function loadCache() {
        let searchParams = new URLSearchParams(window.location.search);
        const page = parseInt(searchParams.get("page") ? searchParams.get("page") : 1);
        const size = parseInt(searchParams.get("size") ? searchParams.get("size") : 50);

        cache = window.localStorage.getItem("label");
        if (cache == null) {
          return;
        }

        cache = JSON.parse(cache);
        for (i = 1; i <= $("tbody tr").length; i++) {
          let no = (page - 1) * size + i;
          value = cache[no];
          if (value) {
            $("tbody tr").eq(i - 1).find("input").val(value);
          }
        }
      }

      function saveCache() {
        let searchParams = new URLSearchParams(window.location.search);
        const page = parseInt(searchParams.get("page") ? searchParams.get("page") : 1);
        const size = parseInt(searchParams.get("size") ? searchParams.get("size") : 50);

        cache = window.localStorage.getItem("label");
        if (cache == null) {
          cache = {};
        } else {
          cache = JSON.parse(cache);
        }

        for (i = 1; i <= $("tbody tr").length; i++) {
          let no = (page - 1) * size + i;
          let value = $("tbody tr").eq(i - 1).find("input").val();
          if (value != null && value != "") {
            cache[no] = value;
          }
        }
        window.localStorage.setItem("label", JSON.stringify(cache));

        new Noty({
          type: "success",
          text: "Save cache successfully",
          timeout: 3000,
          theme: "relax"
        }).show();
      }

      function cache2Csv() {
          cache = window.localStorage.getItem("label");
          if (cache == null) {
            return;
          }
          cache = JSON.parse(cache);
          total = Object.keys(cache).length;

          var str = '';
          let count = 0;
          for (var no = 1; count != total; no++) {
            if (cache[no]) {
              str += cache[no];
              count++;
            }
            str += '\r\n';
          }

          return str;
      }

      function exportCSVFile() {
        var csv = cache2Csv();

        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        if (navigator.msSaveBlob) { // IE 10+
            navigator.msSaveBlob(blob, 'label.csv');
        } else {
          var link = document.createElement("a");
          if (link.download !== undefined) { // feature detection
              // Browsers that support HTML5 download attribute
              var url = URL.createObjectURL(blob);
              link.setAttribute("href", url);
              link.setAttribute("download", 'label.csv');
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          }
        }
      }

      $(document).ready(function() {
        let searchParams = new URLSearchParams(window.location.search);
        const page = parseInt(searchParams.get("page") ? searchParams.get("page") : 1);
        const size = parseInt(searchParams.get("size") ? searchParams.get("size") : 50);
        const autoTab = parseInt(searchParams.get("autoTab") ? searchParams.get("autoTab") : 4);
        $("select[name=autoTab]").val(autoTab);

        generateTable(size);
        assignImage(page, size);
        assignPagination(page, size, autoTab);
        loadCache();

        if (autoTab != 0) {
          $("input").keyup(function(event) {
            if ($(event.currentTarget).val().length >= autoTab) {
              let index = $(event.currentTarget).parent().parent().parent().find("input").index($(event.currentTarget));
              $(event.currentTarget).parent().parent().parent().find("input").eq(index + 1).focus();
            }
          });
        }

        $("select#autoTab").change(function(){
          let t = $("select[name=autoTab]").val();
          window.location.href = "?page=" + page + "&size=" + size + "&autoTab=" + t;
        });

        $("#loadCache").click(function() {
          loadCache();
        });

        $("#saveCache").click(function() {
          saveCache();
        });

        $("#export").click(function() {
          exportCSVFile();
        });

        var timeoutId;
        if (timeoutId) {
          clearTimeout(timeoutId);
        }

        timeoutId = setTimeout(function() {
        	saveCache()
        }, 60000);
      });
  </script>
</html>
